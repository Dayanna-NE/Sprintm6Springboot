<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="es">
<head th:replace="plantillas/base :: head">
<body>
<header th:replace="plantillas/base2 :: header"> </header>
<h1 class="text-center mt-4">Registro de Liquidacion</h1>
<hr>
<section class="formulario mb-5">
  <form th:action="@{/liquidacion/crear}" method="post" class="needs-validation was-validated"  th:object="${liquidacionHtml}" >
    <input type="hidden" id="salud">
    <input type="hidden" id="prevision">
    <div class="row g2 mb-5">
      <!----------------------------------Trabajador----------------------------------------------->
      <div class="col-md-6 position-relative mt-3">

          <label for="trabajador2" class="form-label">Trabajadores</label>
          <select class="form-select is-valid" name="trabajador" id="trabajador2" aria-describedby="trabajadorAD" required>
            <option selected disabled value=""><--Selecione--></option>
            <th:block th:each="trabajador :${trabajadoresHtml}">
              <option th:value="${trabajador.idTrabajador}"
                      th:data-salud="${trabajador.institucionSalud.idInstSalud}"
                      th:data-prevision="${trabajador.institucionPrevision.idInstPrevision}"
                      th:text="${trabajador.nombre+' '+trabajador.apellido1+' '+trabajador.apellido2}">
              </option>
            </th:block>
          </select>

        <div id="trabajadorAD" class="invalid-tooltip end-0 rounded-start-pill">
          Seleccione una opci贸n.
        </div>
      </div>
      <!----------------------------------Sueldo Imponible----------------------------------------------->

      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="sueldoImponible" class="form-label">Sueldo Imponible</label>
          <input th:value="*{sueldoImponible}"  type="text" name="sueldoImponible" class="form-control" id="sueldoImponible" placeholder="Sueldo Imponible" required>
        </div>
        <div id="sueldoImponibleAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>
      <!----------------------------------Salud----------------------------------------------->
    </div>
    <div class="row g2 mb-5">
      <div class="col-md-6 position-relative mt-3">
          <label for="institucionSalud2" class="form-label">Instituci贸n de Salud</label>
          <select class="form-select is-valid" name="institucionSalud" id="institucionSalud2" aria-describedby="institucionSaludAD" required>
            <option selected disabled value=""><--Selecione--></option>
            <th:block th:each="salud :${listaSaludHtml}">
              <option th:value="${salud.idInstSalud}"
                      th:data-salud-dcto="${salud.procDcto}"
                      th:text="${salud.descripcion}"
              ></option>
            </th:block>
          </select>

        <div id="institucionSaludAD" class="invalid-tooltip end-0 rounded-start-pill">
          Seleccione una opci贸n.
        </div>
      </div>
      <!----------------------------------Monto Salud----------------------------------------------->
      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="montoInstSalud" class="form-label">Monto Salud</label>
          <input th:value="*{montoInstSalud}"  type="text" name="montoInstSalud" class="form-control" id="montoInstSalud" placeholder="Monto Insitucion Salud" aria-description="montoInstSaludAD" readonly>
        </div>
        <div id="montoInstSaludAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>

      <!----------------------------------AFP----------------------------------------------->
    </div>
    <div class="row g2 mb-5">
      <div class="col-md-6 position-relative mt-3">
          <label for="institucionPrevision2" class="form-label">AFP</label>
          <select class="form-select is-valid" name="institucionPrevision" id="institucionPrevision2" aria-describedby="institucionPrevisionAD" required >
            <option selected disabled value=""><--Selecione--></option>
            <th:block th:each="prevision : ${listaPrevisionHtml}">
              <option th:value="${prevision.idInstPrevision}"
                      th:data-prevision-dcto="${prevision.proDcto}"
                      th:text="${prevision.descripcion}">...</option>
            </th:block>
          </select>

        <div id="institucionPrevisionAD" class="invalid-tooltip end-0 rounded-start-pill">
          Seleccione una opci贸n.
        </div>
      </div>

      <!----------------------------------Monto AFP----------------------------------------------->

      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="montoInstPrevisional" class="form-label">Monto AFP</label>
          <input th:value="*{montoInstPrevisional}"  type="text" name="montoInstPrevisional" class="form-control" id="montoInstPrevisional" placeholder="Monto AFP" aria-description="montoInstPrevisionalAD" readonly>
        </div>
        <div id="montoInstPrevisionalAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>

      <!----------------------------------Total Descuentos----------------------------------------------->
    </div>
    <div class="row g2 mb-5">
      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="totalDescuento" class="form-label">Total Descuentos</label>
          <input th:value="*{totalDescuento}"  type="text" name="totalDescuento" class="form-control" id="totalDescuento" placeholder="Total Descuento" aria-description="totalDescuentoAD" readonly>
        </div>
        <div id="totalDescuentoAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>
      <!----------------------------------Total Haberes----------------------------------------------->
      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="totalHaberes" class="form-label">Total Haberes</label>
          <input th:value="*{totalHaberes}"  type="text" name="totalHaberes" class="form-control" id="totalHaberes" placeholder="Total Haberes" aria-description="totalHaberesAD" readonly>
        </div>
        <div id="totalHaberesAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>
      <!----------------------------------Anticipo----------------------------------------------->
    </div>
    <div class="row g2 mb-5">
      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="anticipo" class="form-label">Anticipo</label>
          <input th:value="*{anticipo}"  type="text" name="anticipo" class="form-control" id="anticipo" placeholder="Anticipo" aria-description="anticipoAD" required>
        </div>
        <div id="anticipoAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>
      <!----------------------------------Sueldo Liquido----------------------------------------------->
      <div class="col-md-6 position-relative mt-3">
        <div class="mb-3">
          <label for="sueldoLiquido" class="form-label">Sueldo Liquido</label>
          <input th:value="*{sueldoLiquido}"  type="text" name="sueldoLiquido" class="form-control" id="sueldoLiquido" placeholder="Sueldo Liquido" aria-description="sueldoLiquidoAD" readonly>
        </div>
        <div id="sueldoLiquidoAD" class="invalid-tooltip end-0 rounded-start-pill">
          Digite su sueldo imponible.
        </div>
      </div>
      <!----------------------------------Botton----------------------------------------------->
    </div>
    <div class="btnRegistrar mb-3">
      <button type="submit" class="btn btn-primary mt-3 w-50"><i class="fas fa-plus" ></i> Registrar Trabajador</button>
    </div>
  </form>
</section>
<footer th:replace="plantillas/base :: footer"></footer>
<section th:replace="plantillas/base :: script"></section>
<!-- /////////////////////////////////////////// JS ////////////////////////////////// -->
<script>
  $(document).ready(function () {
    // --------------------------- Al selecionar Trabajador------------------
    $('#trabajador2').change(function () {
      const opcionSelecionada = $(this).find('option:selected');
      const idSalud = opcionSelecionada.data('salud');
      const idPrevision = opcionSelecionada.data('prevision');
      console.log(idSalud);
      console.log(idPrevision);
      $('#institucionSalud2').val(idSalud).change();
      $('#institucionPrevision2').val(idPrevision).change();
    });
    // --------------------------- Activando Select Salud -----------------
    $('#institucionSalud2').change(function (){
      const opcionSelecionada = $(this).find('option:selected');
      const saludDcto = opcionSelecionada.data('salud-dcto');
      console.log(saludDcto);
      $('#montoInstSalud').val(saludDcto+'%');
      $('#salud').val(saludDcto/100);
    });
    // ------------------------ Activando Select Prevision -----------
    $('#institucionPrevision2').change(function () {
      const opcionSelecionada = $(this).find('option:selected');
      const previsionDcto = opcionSelecionada.data('prevision-dcto');
      console.log(previsionDcto);
      $('#montoInstPrevisional').val(previsionDcto+'%');
      $('#prevision').val(previsionDcto/100);
    });
    // -------------------------------- Suelo Inponible ---------------------
    $('#sueldoImponible').on('input',function (){
      formatoMoneda(this);
      // --------------------------- Declaracion Variables
        const salud=$('#salud').val();
        const prevision = $('#prevision').val();
      console.log("constante Salud: "+salud);
      console.log("constante prevision"+prevision);
        let montoSalud=0.0;
        let montoPrevicion=0.0;
        let totalDescuento=0.0;
        let totalHaberes=0;
        let sueldoLiquido;
        let sueldoInponible = formatoEntero($(this).val());
        console.log(montoSalud);
        console.log(montoPrevicion);
        console.log(totalDescuento);
        console.log(totalHaberes);
      console.log(sueldoInponible);
      // ----------------------------------Iniciando Operaciones----------------
        montoSalud= sueldoInponible * salud;
        montoPrevicion= sueldoInponible * prevision;
        totalDescuento = montoSalud + montoPrevicion;
        totalHaberes= sueldoInponible - totalDescuento;
        sueldoLiquido = totalHaberes;

      console.log("monto salud: "+montoSalud);
      console.log("monto afp: "+montoPrevicion);
      console.log(totalDescuento);
      console.log(totalHaberes);

      // ------------------------- Entregando valores
        $('#montoInstSalud').val(montoSalud);
        $('#montoInstPrevisional').val(montoPrevicion);
        $('#totalDescuento').val(totalDescuento);
        $('#totalHaberes').val(totalHaberes);
        $('#sueldoLiquido').val(sueldoLiquido);
    });
      //-------------------------Anticipo -------------------------------
    $('#anticipo').on('input',function () {

      let anticipo = formatoEntero($(this).val());
      let sueldoTotal = formatoEntero($('#totalHaberes').val());
      sueldoTotal = sueldoTotal - anticipo;
      $('#sueldoLiquido').val(sueldoTotal);

    });

    // --------------------------transformar a moneda------------------------------//
    function formatoMoneda(input) {
      // Eliminamos cualquier car谩cter no num茅rico que no sea el punto decimal
      let valor = input.value.replace(/[^\d.]/g, '');

      // Si el valor comienza con un punto decimal, lo reemplazamos por 0.
      if (valor.startsWith('.')) {
        valor = '0' + valor;
      }

      // Dividimos el valor en parte entera y decimal, si aplica.
      let partes = valor.split('.');
      let parteEntera = partes[0];
      let parteDecimal = partes.length > 1 ? '.' + partes[1] : '';

      // A帽adimos un separador de miles a la parte entera.
      parteEntera = parteEntera.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

      // Limitamos el n煤mero de decimales a dos.
      parteDecimal = parteDecimal.slice(0, 3);
      input.value = ''+ parteEntera + parteDecimal;
      // Unimos las partes y mostramos el resultado en el input.
      //input.value = '$' + parteEntera + parteDecimal;
    }
  // ------------------------------------- formato entero --------------------------------//
    function formatoEntero(valor){
      //eliminamos cualquier caracter que no sea numero
      return valor.replace(/[^0-9.]+/g, '');
    }


  });
</script>
</body>
</html>